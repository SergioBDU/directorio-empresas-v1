<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio Empresas v1.1 - Completo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0e27; --card: rgba(255,255,255,0.05); --text: #fff;
            --text-dim: #a0a8c8; --accent: #6366f1; --success: #10b981; --border: rgba(255,255,255,0.1);
        }
        body { font-family: Inter, sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); color: var(--text); min-height: 100vh; }
        .header { padding: 2rem; background: rgba(99,102,241,0.1); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; gap: 2rem; }
        .logo { width: 60px; height: 60px; background: linear-gradient(135deg, var(--accent), #818cf8); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        h1 { font-size: 2rem; font-weight: 800; }
        .subtitle { color: var(--text-dim); font-size: 0.9rem; margin-top: 0.25rem; }
        .sync { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 0.85rem; margin-left: auto; }
        .sync.syncing { color: #fbbf24; } .sync.synced { color: var(--success); }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; transition: all 0.3s; }
        .stat:hover { transform: translateY(-5px); border-color: var(--accent); }
        .stat-val { font-size: 2.5rem; font-weight: 800; color: var(--accent); }
        .stat-label { color: var(--text-dim); margin-top: 0.5rem; font-size: 0.9rem; }
        .controls { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; }
        .search { flex: 1; min-width: 200px; position: relative; }
        .search input { width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 0.95rem; }
        .search i { position: absolute; left: 0.85rem; top: 50%; transform: translateY(-50%); color: var(--text-dim); }
        .btn { padding: 0.75rem 1.25rem; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; background: linear-gradient(135deg, var(--accent), #818cf8); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99,102,241,0.4); }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 2rem; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; overflow: hidden; transition: all 0.4s; position: relative; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: var(--card-color, var(--accent)); }
        .card:hover { transform: translateY(-10px); box-shadow: 0 25px 70px rgba(0,0,0,0.3); }
        .card-head { padding: 2rem; display: flex; align-items: center; gap: 1.5rem; border-bottom: 1px solid var(--border); }
        .logo-img { width: 80px; height: 80px; object-fit: contain; border-radius: 16px; background: rgba(255,255,255,0.95); padding: 0.75rem; box-shadow: 0 8px 24px rgba(0,0,0,0.2); flex-shrink: 0; }
        .card-text { flex: 1; position: relative; z-index: 10; }
        .card-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem; }
        .card-sub { color: var(--text-dim); font-size: 0.9rem; line-height: 1.4; }
        .resp-box { margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, rgba(99,102,241,0.2) 0%, rgba(139,92,246,0.2) 100%); border: 1px solid rgba(99,102,241,0.3); border-radius: 10px; position: relative; z-index: 100; }
        .resp-box button { margin-left: auto; background: rgba(255,255,255,0.1); border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; position: relative; z-index: 101; color: var(--text); font-size: 0.8rem; }
        .resp-box button:hover { background: rgba(99,102,241,0.3); }
        .btn-resp { margin-top: 0.75rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.05); border: 1px dashed var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: var(--text-dim); font-size: 0.85rem; transition: all 0.3s ease; position: relative; z-index: 100; }
        .btn-resp:hover { border-color: var(--accent); color: var(--accent); background: rgba(99,102,241,0.1); }
        .card-body { padding: 2rem; }
        .info { margin-bottom: 1.5rem; }
        .info-label { font-weight: 600; font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .info-label i { color: var(--card-color); }
        .info-text { color: var(--text); line-height: 1.6; margin-bottom: 0.5rem; }
        .map-embed { width: 100%; min-height: 280px; border-radius: 12px; overflow: hidden; margin-top: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%); border: 2px solid var(--border); position: relative; }
        .map-embed iframe { width: 100%; height: 280px; border: 0; display: block; }
        .prov { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem; position: relative; overflow: hidden; }
        .prov::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--card-color); }
        .links { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }
        .link { padding: 0.75rem 1.25rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; text-decoration: none; color: var(--text); font-size: 0.9rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 500; position: relative; z-index: 10; cursor: pointer; }
        .link:hover { background: var(--card-color); border-color: var(--card-color); transform: translateY(-2px); }
        .link.whatsapp { background: #25D366; border-color: #25D366; }
        .link.add-whatsapp { border: 1px dashed #25D366; color: #25D366; background: rgba(37,211,102,0.1); }
        .social-links { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }
        .social { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: all 0.3s ease; font-size: 1.2rem; position: relative; z-index: 10; cursor: pointer; }
        .social:hover { transform: translateY(-5px) scale(1.1); box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
        .social.facebook { background: #1877f2; color: white; }
        .social.twitter { background: #1da1f2; color: white; }
        .social.youtube { background: #ff0000; color: white; }
        .social.tiktok { background: #000000; color: white; }
        .social.instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; }
        .social.linkedin { background: #0077b5; color: white; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .modal.show { display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal-box { background: var(--bg); border: 1px solid var(--border); padding: 2.5rem; border-radius: 24px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 30px 90px rgba(0,0,0,0.5); }
        .modal-box.large { max-width: 800px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .close { background: rgba(255,255,255,0.1); border: none; width: 40px; height: 40px; border-radius: 10px; font-size: 1.5rem; cursor: pointer; color: var(--text-dim); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .close:hover { background: rgba(255,77,77,0.2); color: #ff4d4d; transform: rotate(90deg); }
        .form { margin-bottom: 1.25rem; }
        .form label { display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text); font-size: 0.9rem; }
        .form input, .form select, .form textarea { width: 100%; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'Inter', sans-serif; font-size: 1rem; transition: all 0.3s ease; }
        .form input:focus, .form select:focus, .form textarea:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.08); box-shadow: 0 0 0 4px rgba(99,102,241,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .notif { position: fixed; top: 2rem; right: 2rem; background: linear-gradient(135deg, var(--success), #34d399); color: white; padding: 1.25rem 1.75rem; border-radius: 16px; box-shadow: 0 10px 40px rgba(16,185,129,0.4); display: none; align-items: center; gap: 1rem; z-index: 3000; font-weight: 600; }
        .notif.show { display: flex; animation: slideIn 0.4s ease; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10,14,39,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 1rem; }
        .loading.hide { display: none; }
        .spin { width: 50px; height: 50px; border: 4px solid rgba(99,102,241,0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin: 1rem 0; }
        @media (max-width: 768px) { h1 { font-size: 1.75rem; } .container { padding: 1rem; } .grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="loading" id="load">
        <div class="spin"></div>
        <div style="color: var(--text); font-size: 1.1rem; font-weight: 600;">Cargando desde Firebase...</div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="logo"><i class="fas fa-building"></i></div>
            <div>
                <h1>Directorio Empresas v1.1</h1>
                <p class="subtitle">Sistema Colaborativo en la Nube üî•</p>
            </div>
            <div class="sync synced" id="sync">
                <i class="fas fa-cloud-upload-alt"></i>
                <span id="syncTxt">Sincronizado</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats">
            <div class="stat">
                <div class="stat-val" id="total">0</div>
                <div class="stat-label">Empresas Registradas</div>
            </div>
            <div class="stat">
                <div class="stat-val" id="provs">0</div>
                <div class="stat-label">Proveedores Activos</div>
            </div>
            <div class="stat">
                <div class="stat-val">CDMX</div>
                <div class="stat-label">Ubicaci√≥n Principal</div>
            </div>
        </div>

        <div class="controls">
            <div class="search">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Buscar empresa, proveedor o ubicaci√≥n...">
            </div>
            <button class="btn" onclick="exportData()">
                <i class="fas fa-download"></i> Exportar
            </button>
            <button class="btn" onclick="openCampos()" style="background: linear-gradient(135deg, #8338ec 0%, #a78bfa 100%);">
                <i class="fas fa-cog"></i> Campos Personalizados
            </button>
        </div>

        <div class="grid" id="grid"></div>
    </div>

    <!-- Modal: Asignar Responsable -->
    <div id="modalResp" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3 class="modal-title"><i class="fas fa-user-tie"></i> Asignar Responsable</h3>
                <button class="close" onclick="closeResp()">√ó</button>
            </div>
            <div class="form">
                <label>Nombre del Responsable</label>
                <input type="text" id="inpResp" placeholder="Ej: Juan P√©rez">
            </div>
            <button class="btn" style="width: 100%;" onclick="saveResp()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>

    <!-- Modal: Editar Todo -->
    <div id="modalEdit" class="modal">
        <div class="modal-box large">
            <div class="modal-head">
                <h3 class="modal-title"><i class="fas fa-edit"></i> Editar Informaci√≥n Completa</h3>
                <button class="close" onclick="closeEdit()">√ó</button>
            </div>
            <div id="editForm"></div>
        </div>
    </div>

    <!-- Modal: Agregar WhatsApp -->
    <div id="modalWhatsApp" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3 class="modal-title"><i class="fab fa-whatsapp"></i> Agregar WhatsApp</h3>
                <button class="close" onclick="closeWhatsApp()">√ó</button>
            </div>
            <div class="form">
                <label>N√∫mero de WhatsApp (solo n√∫meros)</label>
                <input type="text" id="inpWhatsApp" placeholder="5554370804">
                <p style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.5rem;">
                    Ejemplo: 5554370804 (10 d√≠gitos sin espacios ni guiones)
                </p>
            </div>
            <button class="btn" style="width: 100%;" onclick="saveWhatsApp()">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>

    <!-- Modal: Campos Personalizados -->
    <div id="modalCampos" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <h3 class="modal-title"><i class="fas fa-cog"></i> Gestionar Campos Personalizados</h3>
                <button class="close" onclick="closeCampos()">√ó</button>
            </div>
            <div>
                <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                    Agrega campos adicionales personalizados y especifica si pertenecen a la Empresa o al Proveedor
                </p>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <input type="text" id="nuevoCampo" placeholder="Nombre del campo (ej: RFC, Cuenta Bancaria)" style="flex: 1; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'Inter', sans-serif; font-size: 1rem;">
                    <select id="tipoCampo" style="padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'Inter', sans-serif; font-size: 1rem; min-width: 140px;">
                        <option value="empresa">Empresa</option>
                        <option value="proveedor">Proveedor</option>
                    </select>
                    <button class="btn" onclick="addCampo()">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>

                <div id="listaCampos" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div class="notif" id="notif">
        <i class="fas fa-check-circle"></i>
        <span id="notifTxt"></span>
    </div>

    <script>
        // Configuraci√≥n Firebase
        const cfg = {
            apiKey: "AIzaSyCJCDWaT6lJwB7nMHsOgVmwAK9USVOT6wE",
            authDomain: "directorio-empresas-2025.firebaseapp.com",
            projectId: "directorio-empresas-2025",
            storageBucket: "directorio-empresas-2025.firebasestorage.app",
            messagingSenderId: "193370046732",
            appId: "1:193370046732:web:ad0f3bb81f810502b68929"
        };

        firebase.initializeApp(cfg);
        const db = firebase.firestore();
        let data = [];
        let campos = [];
        let currId = null;

        // Cargar datos
        async function load() {
            try {
                status('syncing', 'Cargando...');
                const snap = await db.collection('empresas').orderBy('nombreComercial').get();
                data = [];
                snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                
                if (data.length === 0) {
                    document.getElementById('load').innerHTML = `
                        <div style="text-align: center; max-width: 600px;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üöÄ</div>
                            <h2 style="font-size: 2rem; margin-bottom: 1rem;">¬°Firebase Conectado!</h2>
                            <p style="color: var(--text-dim); margin-bottom: 2rem; font-size: 1.1rem;">
                                La base de datos est√° lista. Todas las empresas ya est√°n cargadas desde la versi√≥n anterior.
                            </p>
                        </div>
                    `;
                    setTimeout(() => document.getElementById('load').classList.add('hide'), 3000);
                    return;
                }
                
                // Cargar campos personalizados
                const cSnap = await db.collection('campos').get();
                campos = [];
                cSnap.forEach(doc => campos.push({ id: doc.id, ...doc.data() }));
                
                render();
                stats();
                status('synced', 'Sincronizado');
                document.getElementById('load').classList.add('hide');
            } catch (e) {
                console.error(e);
                status('syncing', 'Error');
                notif('Error: ' + e.message);
                document.getElementById('load').classList.add('hide');
            }
        }

        // Escuchar cambios en tiempo real
        db.collection('empresas').onSnapshot(snap => {
            snap.docChanges().forEach(ch => {
                if (ch.type === 'modified') {
                    const d = { id: ch.doc.id, ...ch.doc.data() };
                    const i = data.findIndex(e => e.id === ch.doc.id);
                    if (i !== -1) {
                        data[i] = d;
                        render();
                        stats();
                    }
                }
            });
        });

        // Renderizar tarjetas
        function render() {
            const g = document.getElementById('grid');
            g.innerHTML = '';
            data.forEach(e => g.appendChild(createCard(e)));
        }
        // Crear tarjeta
        function createCard(e) {
            const c = document.createElement('div');
            c.className = 'card';
            c.style.setProperty('--card-color', e.color || '#6366f1');
            
            const numInt = e.direccion?.numInt && e.direccion?.numInt !== 'N/A' ? `, Int. ${e.direccion.numInt}` : '';
            const piso = e.direccion?.piso ? `, Piso ${e.direccion.piso}` : '';
            const dir = `${e.direccion?.calle || ''} ${e.direccion?.numero || ''}${numInt}${piso}, ${e.direccion?.colonia || ''}, ${e.direccion?.alcaldia || ''}, ${e.direccion?.ciudad || ''} ${e.direccion?.cp || ''}`;
            
            const resp = e.responsable ?
                `<div class="resp-box">
                    <i class="fas fa-user-tie" style="color: var(--accent);"></i>
                    <span style="font-size: 0.9rem; color: var(--text); font-weight: 600;">Responsable:</span>
                    <span style="font-size: 0.9rem; color: var(--accent-light);">${e.responsable}</span>
                    <button onclick="editResp('${e.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>` :
                `<button class="btn-resp" onclick="editResp('${e.id}')">
                    <i class="fas fa-user-plus"></i>
                    <span>Asignar Responsable</span>
                </button>`;
            
            const sociales = Object.entries(e.redes || {})
                .filter(([k,v]) => v)
                .map(([k,v]) => `<a href="${v}" target="_blank" rel="noopener noreferrer" class="social ${k}" title="${k}"><i class="fab fa-${k}"></i></a>`)
                .join('');
            
            const camposEmp = campos.filter(cp => cp.tipo === 'empresa').map(cp => {
                const val = e.camposPersonalizados?.[cp.nombre] || '<span style="color: var(--text-dim); font-style: italic;">No especificado</span>';
                return `<div class="info"><div class="info-label"><i class="fas fa-tag"></i> ${cp.nombre}</div><div class="info-text">${val}</div></div>`;
            }).join('');
            
            const camposProv = campos.filter(cp => cp.tipo === 'proveedor').map(cp => {
                const val = e.proveedor?.camposPersonalizados?.[cp.nombre] || '<span style="color: var(--text-dim); font-style: italic;">No especificado</span>';
                return `<div class="info-text" style="margin-top: 0.5rem;"><strong>${cp.nombre}:</strong> ${val}</div>`;
            }).join('');
            
            c.innerHTML = `
                <div class="card-head">
                    <img src="${e.logo || ''}" alt="${e.nombreComercial || ''}" class="logo-img">
                    <div class="card-text">
                        <div class="card-title">${e.nombreComercial || 'Sin nombre'}</div>
                        <div class="card-sub">${e.razonSocial || ''}</div>
                        ${resp}
                    </div>
                </div>
                <div class="card-body">
                    <div class="action-buttons">
                        <button class="btn btn-small" onclick="openEdit('${e.id}')" style="width: 100%;">
                            <i class="fas fa-edit"></i> Editar Todo
                        </button>
                        <button class="btn btn-small" onclick="openEdit('${e.id}')" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                            <i class="fas fa-history"></i> Historial
                        </button>
                    </div>
                    
                    <div class="info">
                        <div class="info-label"><i class="fas fa-map-marker-alt"></i> Direcci√≥n</div>
                        <div class="info-text">${dir}</div>
                        ${e.mapsUrl ? `<a href="${e.mapsUrl}" target="_blank" rel="noopener noreferrer" class="link" style="margin-top: 0.75rem; background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);"><i class="fas fa-map-marked-alt"></i> Ver en Google Maps</a>` : ''}
                    </div>
                    
                    ${e.mapsEmbed ? `
                        <div class="info">
                            <div class="info-label"><i class="fas fa-map"></i> Mapa de Ubicaci√≥n</div>
                            <div class="map-embed">
                                <iframe 
                                    src="${e.mapsEmbed}" 
                                    width="100%" 
                                    height="280" 
                                    style="border: 0;" 
                                    allowfullscreen="" 
                                    loading="eager"
                                    referrerpolicy="no-referrer-when-downgrade"
                                    title="Ubicaci√≥n de ${e.nombreComercial}">
                                </iframe>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="info">
                        <div class="info-label"><i class="fas fa-envelope"></i> Contacto Empresa</div>
                        <div class="links">
                            ${e.contacto?.email ? `<a href="mailto:${e.contacto.email}" class="link"><i class="fas fa-envelope"></i> ${e.contacto.email}</a>` : ''}
                            ${e.contacto?.telefono ? `<a href="tel:${e.contacto.telefono}" class="link"><i class="fas fa-phone"></i> ${e.contacto.telefono}</a>` : ''}
                            ${e.contacto?.dominio ? `<a href="${e.contacto.dominio}" target="_blank" rel="noopener noreferrer" class="link"><i class="fas fa-globe"></i> Sitio Web</a>` : ''}
                        </div>
                    </div>
                    
                    ${sociales ? `
                        <div class="info">
                            <div class="info-label"><i class="fas fa-share-alt"></i> Redes Sociales</div>
                            <div class="social-links">${sociales}</div>
                        </div>
                    ` : ''}
                    
                    ${camposEmp}
                    
                    <div class="prov">
                        <div class="info-label"><i class="fas fa-building"></i> Proveedor de Renta</div>
                        <div class="info-text"><strong>${e.proveedor?.nombre || 'No especificado'}</strong></div>
                        <div class="info-text">Contacto: ${e.proveedor?.contacto || 'N/A'}</div>
                        ${camposProv}
                        <div class="links">
                            ${e.proveedor?.email ? `<a href="mailto:${e.proveedor.email}" class="link"><i class="fas fa-envelope"></i> ${e.proveedor.email}</a>` : ''}
                            ${e.proveedor?.telefono ? `<a href="tel:${e.proveedor.telefono}" class="link"><i class="fas fa-phone"></i> ${e.proveedor.telefono}</a>` : ''}
                            ${e.proveedor?.whatsapp ? 
                                `<a href="https://wa.me/${e.proveedor.whatsapp}" target="_blank" rel="noopener noreferrer" class="link whatsapp">
                                    <i class="fab fa-whatsapp"></i> ${e.proveedor.whatsapp}
                                </a>` : 
                                `<button class="link add-whatsapp" onclick="openWhatsApp('${e.id}')">
                                    <i class="fab fa-whatsapp"></i> Agregar WhatsApp
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `;
            return c;
        }

        // Responsable
        function editResp(id) {
            currId = id;
            const e = data.find(x => x.id === id);
            document.getElementById('inpResp').value = e?.responsable || '';
            document.getElementById('modalResp').classList.add('show');
        }

        async function saveResp() {
            const r = document.getElementById('inpResp').value.trim();
            if (!r) return notif('‚ö†Ô∏è Ingresa un nombre');
            try {
                status('syncing', 'Guardando...');
                await db.collection('empresas').doc(currId).update({ responsable: r });
                const e = data.find(x => x.id === currId);
                if (e) e.responsable = r;
                render();
                closeResp();
                notif('‚úì Responsable actualizado');
                status('synced', 'Sincronizado');
            } catch (e) {
                notif('‚ùå Error: ' + e.message);
                status('synced', 'Error');
            }
        }

        function closeResp() {
            document.getElementById('modalResp').classList.remove('show');
            currId = null;
        }

        // WhatsApp
        function openWhatsApp(id) {
            currId = id;
            document.getElementById('inpWhatsApp').value = '';
            document.getElementById('modalWhatsApp').classList.add('show');
        }

        async function saveWhatsApp() {
            const w = document.getElementById('inpWhatsApp').value.trim();
            if (!w) return notif('‚ö†Ô∏è Ingresa un n√∫mero');
            if (!/^\d{10}$/.test(w)) return notif('‚ö†Ô∏è Debe ser un n√∫mero de 10 d√≠gitos');
            
            try {
                status('syncing', 'Guardando...');
                await db.collection('empresas').doc(currId).update({ 
                    'proveedor.whatsapp': w 
                });
                const e = data.find(x => x.id === currId);
                if (e && e.proveedor) e.proveedor.whatsapp = w;
                render();
                closeWhatsApp();
                notif('‚úì WhatsApp agregado');
                status('synced', 'Sincronizado');
            } catch (e) {
                notif('‚ùå Error: ' + e.message);
                status('synced', 'Error');
            }
        }

        function closeWhatsApp() {
            document.getElementById('modalWhatsApp').classList.remove('show');
            currId = null;
        }
        // Editar Todo
        function openEdit(id) {
            currId = id;
            const e = data.find(x => x.id === id);
            if (!e) return;
            
            const camposEmpresaHTML = campos.filter(c => c.tipo === 'empresa').map(c => {
                const val = e.camposPersonalizados?.[c.nombre] || '';
                return `
                    <div class="form">
                        <label>${c.nombre}</label>
                        <input type="text" id="campoEmp_${c.nombre}" value="${val}">
                    </div>
                `;
            }).join('');
            
            const camposProveedorHTML = campos.filter(c => c.tipo === 'proveedor').map(c => {
                const val = e.proveedor?.camposPersonalizados?.[c.nombre] || '';
                return `
                    <div class="form">
                        <label>${c.nombre}</label>
                        <input type="text" id="campoProv_${c.nombre}" value="${val}">
                    </div>
                `;
            }).join('');
            
            document.getElementById('editForm').innerHTML = `
                <h4 style="margin-bottom: 1rem; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                    <i class="fas fa-building"></i> Informaci√≥n de la Empresa
                </h4>
                
                <div class="form">
                    <label>Nombre Comercial</label>
                    <input type="text" id="editNombreComercial" value="${e.nombreComercial || ''}">
                </div>
                
                <div class="form">
                    <label>Raz√≥n Social</label>
                    <input type="text" id="editRazonSocial" value="${e.razonSocial || ''}">
                </div>
                
                <h4 style="margin: 2rem 0 1rem 0; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                    <i class="fas fa-map-marker-alt"></i> Direcci√≥n
                </h4>
                
                <div class="form-row">
                    <div class="form">
                        <label>Calle</label>
                        <input type="text" id="editCalle" value="${e.direccion?.calle || ''}">
                    </div>
                    <div class="form">
                        <label>N√∫mero</label>
                        <input type="text" id="editNumero" value="${e.direccion?.numero || ''}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form">
                        <label>Interior</label>
                        <input type="text" id="editNumInt" value="${e.direccion?.numInt || ''}">
                    </div>
                    <div class="form">
                        <label>Piso</label>
                        <input type="text" id="editPiso" value="${e.direccion?.piso || ''}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form">
                        <label>Colonia</label>
                        <input type="text" id="editColonia" value="${e.direccion?.colonia || ''}">
                    </div>
                    <div class="form">
                        <label>Alcald√≠a</label>
                        <input type="text" id="editAlcaldia" value="${e.direccion?.alcaldia || ''}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form">
                        <label>C√≥digo Postal</label>
                        <input type="text" id="editCP" value="${e.direccion?.cp || ''}">
                    </div>
                    <div class="form">
                        <label>Ciudad</label>
                        <input type="text" id="editCiudad" value="${e.direccion?.ciudad || ''}">
                    </div>
                </div>
                
                ${camposEmpresaHTML ? `
                    <h4 style="margin: 2rem 0 1rem 0; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                        <i class="fas fa-star"></i> Campos Personalizados de la Empresa
                    </h4>
                    ${camposEmpresaHTML}
                ` : ''}
                
                <h4 style="margin: 2rem 0 1rem 0; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                    <i class="fas fa-building"></i> Proveedor de Renta
                </h4>
                
                <div class="form">
                    <label>Nombre del Proveedor</label>
                    <input type="text" id="editProvNombre" value="${e.proveedor?.nombre || ''}">
                </div>
                
                <div class="form">
                    <label>Contacto</label>
                    <input type="text" id="editProvContacto" value="${e.proveedor?.contacto || ''}">
                </div>
                
                <div class="form">
                    <label>Email</label>
                    <input type="text" id="editProvEmail" value="${e.proveedor?.email || ''}">
                </div>
                
                <div class="form">
                    <label>Tel√©fono</label>
                    <input type="text" id="editProvTelefono" value="${e.proveedor?.telefono || ''}">
                </div>
                
                <div class="form">
                    <label><i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp</label>
                    <input type="text" id="editProvWhatsApp" value="${e.proveedor?.whatsapp || ''}" placeholder="5554370804">
                </div>
                
                ${camposProveedorHTML ? `
                    <h4 style="margin: 2rem 0 1rem 0; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                        <i class="fas fa-star"></i> Campos Personalizados del Proveedor
                    </h4>
                    ${camposProveedorHTML}
                ` : ''}
                
                <h4 style="margin: 2rem 0 1rem 0; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                    <i class="fas fa-envelope"></i> Contacto de la Empresa
                </h4>
                
                <div class="form">
                    <label>Email de Contacto</label>
                    <input type="text" id="editContactoEmail" value="${e.contacto?.email || ''}">
                </div>
                
                <div class="form">
                    <label>Tel√©fono de Contacto</label>
                    <input type="text" id="editContactoTelefono" value="${e.contacto?.telefono || ''}">
                </div>
                
                <div class="form">
                    <label>Sitio Web</label>
                    <input type="text" id="editContactoDominio" value="${e.contacto?.dominio || ''}">
                </div>
                
                <button class="btn" style="width: 100%; margin-top: 1.5rem;" onclick="saveEdit()">
                    <i class="fas fa-save"></i> Guardar Todos los Cambios
                </button>
            `;
            
            document.getElementById('modalEdit').classList.add('show');
        }

        async function saveEdit() {
            const e = data.find(x => x.id === currId);
            if (!e) return;
            
            const updates = {
                nombreComercial: document.getElementById('editNombreComercial').value,
                razonSocial: document.getElementById('editRazonSocial').value,
                direccion: {
                    calle: document.getElementById('editCalle').value,
                    numero: document.getElementById('editNumero').value,
                    numInt: document.getElementById('editNumInt').value,
                    piso: document.getElementById('editPiso').value,
                    colonia: document.getElementById('editColonia').value,
                    alcaldia: document.getElementById('editAlcaldia').value,
                    cp: document.getElementById('editCP').value,
                    ciudad: document.getElementById('editCiudad').value
                },
                proveedor: {
                    ...e.proveedor,
                    nombre: document.getElementById('editProvNombre').value,
                    contacto: document.getElementById('editProvContacto').value,
                    email: document.getElementById('editProvEmail').value,
                    telefono: document.getElementById('editProvTelefono').value,
                    whatsapp: document.getElementById('editProvWhatsApp').value,
                    camposPersonalizados: {}
                },
                contacto: {
                    email: document.getElementById('editContactoEmail').value,
                    telefono: document.getElementById('editContactoTelefono').value,
                    dominio: document.getElementById('editContactoDominio').value
                },
                camposPersonalizados: {}
            };
            
            // Campos personalizados empresa
            campos.filter(c => c.tipo === 'empresa').forEach(c => {
                const input = document.getElementById(`campoEmp_${c.nombre}`);
                if (input) updates.camposPersonalizados[c.nombre] = input.value;
            });
            
            // Campos personalizados proveedor
            campos.filter(c => c.tipo === 'proveedor').forEach(c => {
                const input = document.getElementById(`campoProv_${c.nombre}`);
                if (input) updates.proveedor.camposPersonalizados[c.nombre] = input.value;
            });
            
            try {
                status('syncing', 'Guardando...');
                await db.collection('empresas').doc(currId).update(updates);
                Object.assign(e, updates);
                render();
                closeEdit();
                notif('‚úì Informaci√≥n actualizada');
                status('synced', 'Sincronizado');
            } catch (err) {
                notif('‚ùå Error: ' + err.message);
                status('synced', 'Error');
            }
        }

        function closeEdit() {
            document.getElementById('modalEdit').classList.remove('show');
            currId = null;
        }

        // Campos personalizados
        function openCampos() {
            renderCampos();
            document.getElementById('modalCampos').classList.add('show');
        }

        function closeCampos() {
            document.getElementById('modalCampos').classList.remove('show');
        }

        function renderCampos() {
            const list = document.getElementById('listaCampos');
            if (campos.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-dim);"><i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i><p>No hay campos personalizados a√∫n</p></div>';
                return;
            }
            
            list.innerHTML = campos.map((c, i) => {
                const badge = c.tipo === 'empresa' 
                    ? '<span style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">EMPRESA</span>'
                    : '<span style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">PROVEEDOR</span>';
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-tag" style="color: var(--accent);"></i>
                            <span style="font-weight: 600;">${c.nombre}</span>
                            ${badge}
                        </div>
                        <button onclick="delCampo('${c.id}')" style="background: rgba(255,77,77,0.2); border: none; color: #ff4d4d; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,77,77,0.4)'" onmouseout="this.style.background='rgba(255,77,77,0.2)'">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function addCampo() {
            const nombre = document.getElementById('nuevoCampo').value.trim();
            const tipo = document.getElementById('tipoCampo').value;
            
            if (!nombre) return notif('‚ö†Ô∏è Ingresa un nombre');
            if (campos.some(c => c.nombre === nombre)) return notif('‚ö†Ô∏è Este campo ya existe');
            
            try {
                status('syncing', 'Guardando...');
                const docRef = await db.collection('campos').add({ nombre, tipo });
                campos.push({ id: docRef.id, nombre, tipo });
                document.getElementById('nuevoCampo').value = '';
                renderCampos();
                notif('‚úì Campo agregado');
                status('synced', 'Sincronizado');
            } catch (e) {
                notif('‚ùå Error: ' + e.message);
                status('synced', 'Error');
            }
        }

        async function delCampo(id) {
            if (!confirm('¬øEliminar este campo? Se perder√°n los datos asociados.')) return;
            try {
                status('syncing', 'Eliminando...');
                await db.collection('campos').doc(id).delete();
                campos = campos.filter(c => c.id !== id);
                renderCampos();
                render();
                notif('‚úì Campo eliminado');
                status('synced', 'Sincronizado');
            } catch (e) {
                notif('‚ùå Error: ' + e.message);
                status('synced', 'Error');
            }
        }
        // Estad√≠sticas
        function stats() {
            document.getElementById('total').textContent = data.length;
            const provs = new Set(data.map(e => e.proveedor?.nombre).filter(Boolean));
            document.getElementById('provs').textContent = provs.size;
        }

        // UI helpers
        function status(s, t) {
            document.getElementById('sync').className = 'sync ' + s;
            document.getElementById('syncTxt').textContent = t;
        }

        function notif(t) {
            const n = document.getElementById('notif');
            document.getElementById('notifTxt').textContent = t;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // Exportar
        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'directorio_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            notif('‚úì Datos exportados');
        }

        // B√∫squeda
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            if (!search) {
                render();
                return;
            }
            
            const filtered = data.filter(empresa => {
                return empresa.nombreComercial?.toLowerCase().includes(search) ||
                       empresa.razonSocial?.toLowerCase().includes(search) ||
                       empresa.proveedor?.nombre?.toLowerCase().includes(search) ||
                       empresa.proveedor?.contacto?.toLowerCase().includes(search) ||
                       empresa.direccion?.colonia?.toLowerCase().includes(search) ||
                       empresa.direccion?.alcaldia?.toLowerCase().includes(search) ||
                       empresa.responsable?.toLowerCase().includes(search);
            });
            
            const g = document.getElementById('grid');
            g.innerHTML = '';
            filtered.forEach(e => g.appendChild(createCard(e)));
        });

        // Cerrar modales al click fuera
        document.getElementById('modalResp').addEventListener('click', function(e) {
            if (e.target === this) closeResp();
        });
        
        document.getElementById('modalEdit').addEventListener('click', function(e) {
            if (e.target === this) closeEdit();
        });
        
        document.getElementById('modalWhatsApp').addEventListener('click', function(e) {
            if (e.target === this) closeWhatsApp();
        });
        
        document.getElementById('modalCampos').addEventListener('click', function(e) {
            if (e.target === this) closeCampos();
        });

        // Iniciar
        load();
    </script>
</body>
</html>
